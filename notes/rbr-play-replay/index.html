<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Finding and calling Richard Burns Rally play replay function - suXin space</title>
    <meta name="og:title" content="Finding and calling Richard Burns Rally play replay function - suXin space"/>
    <meta name="og:description" content="In this note I want to focus on my thought process for a trivial reverse engineering problem - how do I find the function I want and call it from the code I have control over?"/>
    <meta name="og:url" content="https://suxin.space/notes/rbr-play-replay"/>
    <meta name="og:image" content="https://suxin.space/notes/rbr-play-replay/replay_thumb.jpg"/>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Finding and calling Richard Burns Rally play replay function - suXin space"/>
    <meta name="twitter:description" content="In this note I want to focus on my thought process for a trivial reverse engineering problem - how do I find the function I want and call it from the code I have control over?"/>
    <meta name="twitter:site" content="@suxinjke"/>
    <meta name="twitter:image" content="https://suxin.space/notes/rbr-play-replay/replay_thumb.jpg"/>
    <link rel="stylesheet" href="/normalize.min.css">
    <link rel="stylesheet" href="/fonts/fonts.css">
    <link rel="stylesheet" href="/main.css?t=1736506808576">
    <link rel="stylesheet" href="/notes/note.css?t=1736506808576">
    <link rel="stylesheet" href="/prism-github.css?t=1736506808576">
    <script src="/main.js?t=1736506808576" defer=""></script>
  </head>
  <body>
    <header class="header"><nav class="nav header__nav"><a href="/" class="nav__link"><div class="header-text"><div class="header-text__icon-container"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"/></svg></div><div class="header-text__content" title="Home"><h2 class="header-text__primary uppercase">Home</h2></div></div></a><a href="/notes/" class="nav__link active expand"><div class="header-text"><div class="header-text__icon-container"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"/></svg></div><div class="header-text__content" title="Notes - Finding and calling Richard Burns Rally play replay function"><h3 class="header-text__secondary">Finding and calling Richard Burns Rally play replay function</h3><h2 class="header-text__primary uppercase">Notes</h2></div></div></a></nav><h2 class="header__logo">suXin space</h2></header><main class="readable note short-width"><h1><strong>Finding and calling Richard Burns Rally play replay function</strong></h1><h3 class="uppercase">Mar 30 2020</h3><div class="note__content"><p>In this note I want to share my experience with calling a function that was not exposed via DLL plugin interface. While it may not look impressive for experienced people, or because you can find other examples online that solve similar problem, I believe it&#39;s valuable that I document my experience with approaches, tools used and especially the thought process, which may help other people who learn to reverse engineer or hack.</p>
<p>It&#39;s expected you understand programming, C++ and x86 fundamentals for this reading to be any of your interest.</p>
<h2 id="premise"><strong>Premise</strong><a href="#premise" class="anchor-link"><span>¶</span></a></h2><p>About a year ago I&#39;ve got an idea for a <strong>Richard Burns Rally</strong> plugin that would implement <strong>delta timing</strong>: instead of having the time difference only for two checkpoints like in the original game, the plugin would record the time much more often, as if there were much more checkpoints or splits. This would allow for more rapid feedback to understand where you lose or gain time, and why. This feature is present in many modern simracing games and legitimately helped me to improve at ways I control the car.</p>
<p>Since then I still didn&#39;t start working on this, one of the reasons was the fact that the plugin would be disappointing for me if I wouldn&#39;t be able to compare my time against any replays available on the internet. Technically, it should be possible to take any replay, play it and let the plugin record the splits. There&#39;s only one problem: <strong>original plugin interface is barebones and doesn&#39;t allow to play replays</strong>, which means you don&#39;t have proper control of when you start the replay, meaning you can&#39;t easily setup the recording routine.</p>
<p>So this is my problem: <strong>I have to find the function that the game calls to load and begin replay playback</strong>, so I can call it myself any time in my C++ plugin code. I already had reverse engineering experience, <a  href="/notes/cw-reverse-engineering-models/">but it was limited to parsing 3D model data</a>, this is the first time I had legit game with legit need to use debugger and disassembler, something that is very out of my comfort zone.</p>
<p><div class="image"><div class="image__container"><a href="./replay.jpg" target="_blank" rel="noopener"><img title="This guy on bottom has secret pocket with Red Bull can inside if you wonder" src="./replay.jpg" /></a><h4 class="image__title">This guy on bottom has secret pocket with Red Bull can inside if you wonder</h4></div></div></p>
<h2 id="breakpoint-targeting"><strong>Breakpoint targeting</strong><a href="#breakpoint-targeting" class="anchor-link"><span>¶</span></a></h2><p>Before I get to the debugging part, I first have to figure out where I want to debug. I will assume that there&#39;s some kind of function in the game code that accepts replay file name, and does whatever it has to load the replay. Execution of this function will certainly involve the process of reading the replay file from the directory, meaning that operating system calls will be involved. Since I&#39;m working in <strong>Windows</strong>, my first step is to run <a  href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener"><strong>Process Monitor</strong></a> with filter on <strong>RichardBurnsRally_SSE</strong> and <strong>ReadFile</strong> operation.</p>
<p>This leads me to the only operation I&#39;ve been looking for, and most importantly: the call stack which ends with the in-game memory address where the function was called from: <code>0x452C29</code>. <em>This is where I will setup a breakpoint</em>.</p>
<p><div class="image"><div class="image__container"><a href="./read_file.png" target="_blank" rel="noopener"><img title="Call stack for the ReadFile operation, pointing at the place where it was called from" src="./read_file.png" /></a><h4 class="image__title">Call stack for the ReadFile operation, pointing at the place where it was called from</h4></div></div></p>
<h2 id="debugging"><strong>Debugging</strong><a href="#debugging" class="anchor-link"><span>¶</span></a></h2><p>My lack of reverse engineering experience also includes the lack of preferences for tools. In my case, <a  href="https://www.hex-rays.com/products/ida/" target="_blank" rel="noopener"><strong>IDA Pro</strong></a> which everyone may talk about is paid and expensive, <a  href="https://github.com/radareorg/radare2" target="_blank" rel="noopener"><strong>radare2</strong></a> is console based and may need frontend setup, <a  href="http://www.ollydbg.de/" target="_blank" rel="noopener"><strong>OllyDbg</strong></a> is somewhat outdated and hurts for me to look at. <a  href="https://www.cheatengine.org/" target="_blank" rel="noopener"><strong>Cheat Engine</strong></a> has decent debugger but felt clunky to use. This time I stumbled upon <a  href="https://x64dbg.com/" target="_blank" rel="noopener"><strong>x64dbg</strong></a> which looks like glorified <strong>OllyDbg</strong>, and it&#39;s what I&#39;ve been using to solve my problem, and will probably stick to it for now.</p>
<p>If you also decide to try out <strong>x64dbg</strong>, I highly recommend you check out it&#39;s <strong>Preferences menu</strong>, in my case I found it convenient to turn off all automatic breakpoints and tweak disassembler output settings. I also want to note that it&#39;s also shipped with <strong>x32dbg</strong> executable, targeted at <strong>32-bit applications</strong>, which suits me.</p>
<p>Anyway, I&#39;ve attached to the <strong>RichardBurnsRally_SSE.exe</strong> process, went to the <code>0x452C29</code> address I&#39;ve noted before and set the breakpoint there. After I attempted to select my replay from in-game menu, the debugger paused the execution right where I expected.</p>
<p><div class="image"><div class="image__container"><a href="./first_breakpoint.png" target="_blank" rel="noopener"><img title="x64dbg, but it&apos;s actually x32dbg, click on the picture if it&apos;s too small" src="./first_breakpoint.png" /></a><h4 class="image__title">x64dbg, but it&apos;s actually x32dbg, click on the picture if it&apos;s too small</h4></div></div></p>
<p>I can certainly see the call to <strong>ReadFile</strong> was just made, like it was also seen in <strong>Process Monitor</strong>. After that I look at the stack on bottom right, which has the mention of replay file name - just what I need! <em>If I only I knew where it all began.</em> Checking bottom stack contents from previous function calls reveals, I assume, several <strong>stack frames</strong>. The highlighted replay file name on the screenshot below is the first mention of it at the bottom of stack, therefore I assume that function at the address of <code>0x4999B0</code>, which I labeled as <strong>PlayReplay?</strong> on the screenshot, is what I should focus on.</p>
<p>Here goes my first tip when it comes to solving problems like this, and many others will probably tell you the same: <strong>label everything of your interest</strong>, especially if you stumble upon static stuff like constant addresses. Little things may not make any sense right now, but you may encounter them again later on, which will assemble into a bigger picture.</p>
<p><div class="image"><div class="image__container"><a href="./stack.png" target="_blank" rel="noopener"><img title="Stack contents" src="./stack.png" /></a><h4 class="image__title">Stack contents</h4></div></div></p>
<p>Being familiar with the concept of stack frames, I notice what seems to look like a function with signature of</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> PlayReplay<span class="token operator">?</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>replayName<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>whatever<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>whatever2<span class="token punctuation">,</span> size_t replayFileSize <span class="token punctuation">)</span></code></pre><p>I did notice that 4th argument is replay file size after I tried to load several other replay files. The whatever pointers I marked on 2nd and 3rd arguments turned out to be not really interesting, they point to some memory section and numbers 54 (0x36) and 4 are written there. I didn&#39;t figure out what they&#39;re for so I will keep thinking <em>whatever</em> of them for now.</p>
<p><div class="image"><div class="image__container"><a href="./weird_assignments.png" target="_blank" rel="noopener"><img title="Weird assignments" src="./weird_assignments.png" /></a><h4 class="image__title">Weird assignments</h4></div></div></p>
<h2 id="calling"><strong>Calling</strong><a href="#calling" class="anchor-link"><span>¶</span></a></h2><p>Finding out the function location and assuming what it&#39;s like wasn&#39;t overly difficult. But my attempts at calling it from my controlled DLL plugin code were futile.</p>
<p>Initially, I just made a typedef which represented my assumed function signature:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">function_pointer</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> size_t <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And attempted to call it like:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>function_pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

function_pointer playReplayMaybe <span class="token operator">=</span> <span class="token punctuation">(</span> function_pointer <span class="token punctuation">)</span> <span class="token number">0x4999B0</span><span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> stub1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> stub2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
size_t replayFileSize <span class="token operator">=</span> <span class="token number">250860</span><span class="token punctuation">;</span>

<span class="token function">playReplayMaybe</span><span class="token punctuation">(</span> <span class="token string">"School_Impreza.rpl"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stub1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stub2<span class="token punctuation">,</span> <span class="token number">250860</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Which sadly results in crash. This is where I started to have intrusive thoughts to give up again on reverse engineering, and at the same time I knew I just had to figure out why it happened, after all, <em><strong>the debugger can break on exceptions</strong></em>.</p>
<p>If you scroll up to the pic where I question the weird numbers being written, the last line is where it crashes. For whatever reason, it refers to <strong>ECX</strong> which I didn&#39;t see being set anywhere inside this function, I&#39;d probably expect the data in <strong>ECX</strong> to be among function arguments instead. It made no sense for me. I did notice that <strong>ECX</strong> is being set outside before the function call, the value from constant address is copied, <em>but why <strong>ECX</strong>?</em> How do I set register value before calling? Write inline assembly? That would be ridiculous.</p>
<p>This is what got me stuck for several days. I was taking breaks from this problem and coming back at it again when I felt like it. Around this time I was also reading portions of <a  href="https://www.oreilly.com/library/view/practical-malware-analysis/9781593272906/" target="_blank" rel="noopener"><strong>Practical malware analysis</strong></a> because it had decent examples of compiled code on which I could focus on while reverse engineering. There&#39;s a dedicated C++ section which what the analysed game was developed with, and here&#39;s the quote that have made me realise it all:</p>
<pre class="language-"><code class="language-">The this pointer is implied in every variable access within a function that
doesn’t specify an object; it is an implied parameter to every object function
call. Within Microsoft-generated assembly code, the this parameter is usually
passed in the ECX register, although sometimes ESI is used instead.</code></pre><p>So I was probably dealing with a member function call, and it&#39;s related to a class instance, pointer of which is specified at <strong>ECX</strong>. This makes sense now, but how exactly am I supposed to call such function? Because it&#39;s not like I can easily reconstruct the actual class structure and make it properly point at whatever instance.</p>
<p>Further google helped me to make sense of what are <a  href="https://en.wikipedia.org/wiki/X86_calling_conventions" target="_blank" rel="noopener"><strong>calling conventions</strong></a>, I think I saw mentions of these before but didn&#39;t really understand their purpose, obviously because I wasn&#39;t dealing with them, which is not the case anymore. Here&#39;s what I did:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token punctuation">(</span> __thiscall<span class="token operator">*</span> function_pointer <span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> size_t <span class="token punctuation">)</span><span class="token punctuation">;</span>

function_pointer playReplayMaybe <span class="token operator">=</span> <span class="token punctuation">(</span> function_pointer <span class="token punctuation">)</span> <span class="token number">0x4999B0</span><span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> stub1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> stub2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
size_t replayFileSize <span class="token operator">=</span> <span class="token number">250860</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>classInstancePtr <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token number">0x893634</span><span class="token punctuation">;</span>
<span class="token function">playReplayMaybe</span><span class="token punctuation">(</span> <span class="token operator">*</span>classInstancePtr<span class="token punctuation">,</span> <span class="token string">"School_Impreza.rpl"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stub1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stub2<span class="token punctuation">,</span> replayFileSize <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// which is basically bigClassInstance->playReplayMaybe( "School_Impreza.rpl", ... )</span></code></pre><p><em>And it worked just fine.</em> Now my plugin should be able to render menu with list of replays and play any of them, while also retaining the control over the selection.</p>
<p>There isn&#39;t much else I can add besides pointing out that if I didn&#39;t read the book or something else with mention of <strong>thiscall</strong>, I&#39;d probably be stuck with this problem for much longer time. I believe this is something that you can&#39;t really figure out on your own, this is something <strong>you have to know</strong> to be able to recognize. I can only wonder how many other tricky things and details I will encounter in the future, and have to learn about them.</p>
<p>This is very huge milestone for me, because while simple, it was done on real application for practical purpose.</p>
</div></main>
    
  </body>
</html>